<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuvia - Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    /* Reuse design tokens from other pages (kept small & consistent) */
    :root{--pink:#ff2e92;--yellow:#ffd54f;--blue:#00d5ff;--radius:20px;--border-light:rgba(255,255,255,0.06);--card-background:rgba(25,25,40,0.7);--header-background:linear-gradient(135deg,rgba(10,10,20,.85),rgba(10,10,20,.75));--white:#e0e0e0;--text-light:#a0a0a0;--accent-color:#00d5ff;--delete-button-color:#dc3545}
    html,body{height:100%;margin:0;font-family:'Inter',sans-serif;background:var(--card-background);color:var(--white);-webkit-font-smoothing:antialiased}
    header{background:var(--header-background);border-bottom:1px solid var(--border-light);padding:10px 0;position:fixed;top:0;left:0;width:100%;height:55px;display:flex;justify-content:center;z-index:10}
    .header-content-wrapper{width:100%;max-width:1200px;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:'Poppins',sans-serif;font-weight:800;background-image:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;color:transparent;text-decoration:none}
    .user-profile-header{display:flex;align-items:center;gap:10px}
    .user-profile-header img{width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-color)}

    main{padding-top:55px;display:flex;flex-direction:column;height:calc(100vh - 55px);width:100%;max-width:1000px;margin:12px auto;border-radius:var(--radius);overflow:hidden;background:var(--card-background);box-shadow:0 10px 30px rgba(0,0,0,0.5)}

    .chat-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border-light);background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent)}
    .chat-header .back-btn{background:none;border:none;color:var(--white);font-size:1.1rem;padding:8px;cursor:pointer}
    .chat-header .partner-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-color)}
    .chat-header .partner-name{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.05rem}
    .chat-header .partner-status{color:var(--text-light);font-size:0.85rem}

    .chat-messages{flex:1;padding:12px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
    .message-item{display:flex;align-items:flex-start;gap:8px;max-width:70%}
    .message-item.sent{margin-left:auto;flex-direction:row-reverse}
    .message-item .avatar{width:30px;height:30px;border-radius:50%;object-fit:cover;border:1px solid var(--accent-color)}
    .message-bubble{padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.06);color:var(--white);font-size:0.9rem;word-wrap:break-word}
    .message-item.sent .message-bubble{background:linear-gradient(90deg,var(--blue),var(--pink));color:#fff}
    .message-meta{font-size:0.7rem;color:var(--text-light);margin-top:4px}

    .chat-input-area{padding:10px;border-top:1px solid var(--border-light);display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .input-row{display:flex;gap:8px;align-items:center}
    .chat-input-area textarea{flex:1;padding:10px;border-radius:18px;border:1px solid var(--border-light);background:rgba(0,0,0,0.25);color:var(--white);outline:none;resize:none;min-height:40px;max-height:120px}
    .chat-input-area button.send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(90deg,var(--blue),var(--pink));color:white;cursor:pointer;box-shadow:0 6px 20px rgba(0,213,255,0.12)}
    .attach-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border-light);background:transparent;color:var(--text-light);cursor:pointer}

    #mediaPreviewContainer{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--border-light);display:none}
    #mediaPreview{max-width:70px;max-height:70px;border-radius:6px;object-fit:cover}
    #removeMediaButton{background:none;border:none;color:var(--delete-button-color);cursor:pointer}

    /* small screens */
    @media (max-width:600px){.chat-header .partner-name{font-size:1rem}.message-item .avatar{width:24px;height:24px}.message-bubble{font-size:0.85rem}}
    .is-hidden{display:none}
    .hidden-input{display:none}
    .friends-view{display:flex;flex-direction:column;gap:12px;padding:12px 16px}
    .friends-toolbar{display:flex;gap:8px;align-items:center}
    .friends-search{flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--border-light);background:rgba(0,0,0,0.25);color:var(--white);outline:none}
    .friends-list{display:flex;flex-direction:column;gap:10px}
    .friend-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid var(--border-light);cursor:pointer}
    .friend-item:hover{background:rgba(255,255,255,0.08)}
    .friend-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-color)}
    .friend-name{font-weight:700;display:flex;align-items:center;gap:6px}
    .friend-sub{font-size:.85rem;color:var(--text-light)}
    .friends-empty{color:var(--text-light);text-align:center;padding:12px}
  #headerDisplayName{background-image:linear-gradient(90deg,var(--pink),var(--yellow));-webkit-background-clip:text;background-clip:text;color:transparent}
  .user-profile-header a{ text-decoration:none; color:inherit }
  .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .message-content{position:relative}
  .message-tools{display:flex;align-items:center;gap:6px;margin-top:6px}
  .message-actions-btn{background:transparent;border:none;color:var(--text-light);cursor:pointer}
  .message-actions-menu{position:absolute;right:0;top:0;background:rgba(15,15,25,0.95);border:1px solid var(--border-light);border-radius:8px;padding:6px;display:none;flex-direction:column;gap:4px;z-index:20}
  .message-actions-menu.open{display:flex}
  .message-actions-menu button{background:transparent;border:none;color:var(--white);text-align:left;padding:6px 8px;border-radius:6px;cursor:pointer}
  .message-actions-menu button:hover{background:rgba(255,255,255,0.06)}
  .reaction-bar{display:flex;gap:6px;margin-top:4px}
  .reaction-chip{border:1px solid var(--border-light);border-radius:12px;padding:2px 6px;background:rgba(255,255,255,0.04);cursor:pointer;font-size:0.85rem}
  .reaction-chip.active{border-color:var(--accent-color)}
  .pinned-bar{display:none;padding:8px 12px;border-bottom:1px solid var(--border-light);background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent)}
  .pinned-list{display:flex;gap:6px;flex-wrap:wrap}
  .pinned-chip{border:1px solid var(--border-light);border-radius:12px;padding:2px 8px;background:rgba(255,255,255,0.04);cursor:pointer;font-size:0.8rem}
  .chat-search{display:none;margin-left:auto}
  .chat-search input{background:rgba(0,0,0,0.25);border:1px solid var(--border-light);color:var(--white);border-radius:12px;padding:6px 10px;width:200px}
  .reply-banner{display:none;align-items:center;gap:8px;border:1px solid var(--border-light);background:rgba(255,255,255,0.02);border-radius:8px;padding:6px 8px}
  .reply-text{color:var(--text-light);font-size:0.85rem;flex:1}
  .reply-cancel-btn{background:none;border:none;color:var(--delete-button-color);cursor:pointer}
  .upload-progress{display:none;height:6px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden}
  .upload-progress .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--pink))}
  .drag-over{outline:2px dashed var(--accent-color);outline-offset:-6px}
  .muted-dot{width:8px;height:8px;border-radius:50%;background:var(--text-light);display:inline-block;margin-left:6px;opacity:.7}
  .reply-quote{border-left:3px solid var(--accent-color);padding:4px 8px;margin-bottom:6px;color:var(--text-light);font-size:0.85rem;border-radius:6px;background:rgba(255,255,255,0.03)}
    /* Presence styles */
  :root{ --status-online:#4CAF50; --status-away:#FFC107; --status-offline:#6c757d; }
  .presence-row{display:inline-flex;align-items:center;gap:6px}
  .presence-dot{width:8px;height:8px;border-radius:50%;background:var(--status-offline);box-shadow:none}
  .presence-dot.online{background:var(--status-online);box-shadow:0 0 8px rgba(76,175,80,0.7)}
  .presence-dot.away{background:var(--status-away);box-shadow:0 0 6px rgba(255,193,7,0.8)}
  .presence-text{color:var(--text-light);font-size:0.85rem}
  </style>
</head>
<body class="theme-dark-mode">
  <header>
    <div class="header-content-wrapper">
      <a href="/index.html" class="logo">Nuvia</a>
      <div class="user-profile-header">
        <a id="profileLink" href="/profile.html"><img id="headerProfilePic" src="" alt="Profile" style="display:none"><i id="headerAvatarIcon" class="fas fa-user-circle" style="font-size:28px"></i><span id="headerDisplayName">Loading...</span></a>
      </div>
    </div>
  </header>

  <main>
    <section id="friendsView" class="friends-view is-hidden">
      <div class="friends-toolbar">
        <input id="friendSearchInput" class="friends-search" type="search" placeholder="Search friends">
      </div>
      <div id="friendsLoading" class="friends-empty">Loading friends...</div>
      <div id="friendsEmpty" class="friends-empty" style="display:none">No friends yet.</div>
      <div id="friendsList" class="friends-list"></div>
    </section>
    <div class="chat-header" id="chatHeader">
      <button id="backBtn" class="back-btn" aria-label="Back"><i class="fas fa-arrow-left"></i></button>
      <img id="partnerAvatar" class="partner-avatar" src="" alt="Partner">
      <div style="display:flex;flex-direction:column;">
        <div class="partner-name" id="partnerName">Loading...</div>
        <div class="partner-status" id="partnerStatus">Loading...</div>
      </div>
      <div class="header-actions" style="display:none">
        <div class="chat-search" id="chatSearchWrap"><input id="chatSearchInput" type="search" placeholder="Search messages"></div>
        <button id="searchToggleBtn" class="attach-btn" title="Search"><i class="fas fa-magnifying-glass"></i></button>
        <button id="muteToggleBtn" class="attach-btn" title="Mute/unmute"><i class="fas fa-bell-slash"></i></button>
        <button id="callBtn" class="attach-btn" title="Voice call"><i class="fas fa-phone"></i></button>
        <button id="videoCallBtn" class="attach-btn" title="Video call"><i class="fas fa-video"></i></button>
        <button id="readReceiptsToggleBtn" class="attach-btn" title="Toggle read receipts"><i class="fas fa-check-double"></i></button>
        <div class="vanish-wrap" style="position:relative">
          <button id="vanishBtn" class="attach-btn" title="Disappearing messages"><i class="fas fa-hourglass-half"></i></button>
          <div id="vanishMenu" class="message-actions-menu" style="position:absolute;right:0;top:40px;display:none;">
            <button data-value="0">Off</button>
            <button data-value="60000">1 minute</button>
            <button data-value="3600000">1 hour</button>
            <button data-value="86400000">1 day</button>
          </div>
        </div>
        <button id="headerMenuBtn" class="attach-btn" title="More"><i class="fas fa-ellipsis-vertical"></i></button>
        <button id="viewProfileBtn" class="attach-btn" title="View profile"><i class="fas fa-user"></i></button>
      </div>
    </div>
    <div id="pinnedBar" class="pinned-bar"><div class="pinned-list" id="pinnedList"></div></div>

    <div class="chat-messages" id="chatMessages">
      <p class="messages-loading-text" id="messagesLoading">Loading messages...</p>
    </div>

    <div class="chat-input-area" id="chatInputArea">
      <div id="replyBanner" class="reply-banner"><span class="reply-text" id="replyText"></span><button id="replyCancelBtn" class="reply-cancel-btn" title="Cancel reply"><i class="fas fa-times"></i></button></div>
      <div id="mediaPreviewContainer">
        <img id="mediaPreview" src="" alt="preview">
        <span id="mediaFileName"></span>
        <div class="upload-progress" id="uploadProgress"><div class="bar" id="uploadProgressBar"></div></div>
        <button id="removeMediaButton" title="Remove media"><i class="fas fa-times-circle"></i></button>
      </div>

      <div class="input-row">
        <input type="file" id="mediaInput" accept="image/*,video/*,audio/*" class="hidden-input" multiple>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input">
        <button id="cameraButton" class="attach-btn" title="Camera"><i class="fas fa-camera"></i></button>
        <button id="attachButton" class="attach-btn" title="Attach media"><i class="fas fa-paperclip"></i></button>
        <textarea id="messageInput" placeholder="Type your message..."></textarea>
        <button id="sendButton" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
    <audio id="notifSound" src="ne.mp3" preload="auto"></audio>
  </main>

  <div id="messageBox" style="display:none"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, query, orderBy, onSnapshot, addDoc, serverTimestamp, setDoc, updateDoc, getDocs, where, limit, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getCloudinaryImageUrl, displayProfilePicture } from './assets/js/avatar-utils.js';

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const cloudinaryConfig = { cloudName: 'dxld01rcp', uploadPreset: 'Storage_preset' };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const headerProfilePic = document.getElementById('headerProfilePic');
    const headerAvatarIcon = document.getElementById('headerAvatarIcon');
    const headerDisplayName = document.getElementById('headerDisplayName');
    const profileLink = document.getElementById('profileLink');

    const backBtn = document.getElementById('backBtn');
    const partnerAvatar = document.getElementById('partnerAvatar');
    try{ partnerAvatar.setAttribute('fetchpriority','high'); partnerAvatar.decoding='async'; partnerAvatar.loading='eager'; }catch(_){}
    const partnerNameEl = document.getElementById('partnerName');
    const partnerStatusEl = document.getElementById('partnerStatus');
    const viewProfileBtn = document.getElementById('viewProfileBtn');
    const callBtn = document.getElementById('callBtn');
    const videoCallBtn = document.getElementById('videoCallBtn');
    const readReceiptsToggleBtn = document.getElementById('readReceiptsToggleBtn');
    const vanishBtn = document.getElementById('vanishBtn');
    const vanishMenu = document.getElementById('vanishMenu');

    const chatMessages = document.getElementById('chatMessages');
    const messagesLoading = document.getElementById('messagesLoading');
    const chatHeaderEl = document.getElementById('chatHeader');
    const chatInputAreaEl = document.getElementById('chatInputArea');

    // Friends view DOM
    const friendsView = document.getElementById('friendsView');
    const friendSearchInput = document.getElementById('friendSearchInput');
    const friendsListEl = document.getElementById('friendsList');
    const friendsEmpty = document.getElementById('friendsEmpty');
    const friendsLoading = document.getElementById('friendsLoading');

    const mediaInput = document.getElementById('mediaInput');
    const attachButton = document.getElementById('attachButton');
    const mediaPreviewContainer = document.getElementById('mediaPreviewContainer');
    const mediaPreview = document.getElementById('mediaPreview');
    const mediaFileName = document.getElementById('mediaFileName');
    const removeMediaButton = document.getElementById('removeMediaButton');

    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    let currentUser = null;
    let partnerId = null;
    let partnerProfile = null;
    let chatId = null;
    let unsubscribeMessages = null;

// Ultra-fast message helpers
const MSG_CACHE_KEY = (cid)=> `chat_cache_${appId}_${cid}`;
function loadMessagesCache(cid){ try{ return JSON.parse(sessionStorage.getItem(MSG_CACHE_KEY(cid))||'[]'); }catch(_){ return []; } }
function saveMessagesCache(cid, msgs){ try{ const arr = (msgs||[]).slice(-100); sessionStorage.setItem(MSG_CACHE_KEY(cid), JSON.stringify(arr)); }catch(_){ } }
function isNearBottom(){ try{ const d = chatMessages; return (d.scrollHeight - d.scrollTop - d.clientHeight) < 120; }catch(_){ return true; } }
function appendOrUpdateMessage(m){
  const existing = document.querySelector(`.message-item[data-id="${m.id}"]`);
  if(existing){ updateMessageDom(existing, m); return; }
  renderMessage(m);
}
function updateMessageDom(el, m){
  try{
    el.className = 'message-item ' + ((currentUser && m.senderId===currentUser.uid)? 'sent':'received');
    const contentWrap = el.querySelector('.message-content');
    if(!contentWrap) return;
    const bubble = contentWrap.querySelector('.message-bubble');
    const meta = contentWrap.querySelector('.message-meta');
    if(bubble){ bubble.innerHTML=''; if(m.repliedToText){ const q=document.createElement('div'); q.className='reply-quote'; q.textContent=m.repliedToText; bubble.appendChild(q); }
      if(m.deleted){ const p=document.createElement('div'); p.textContent='Message deleted'; bubble.appendChild(p); }
      else if(m.type==='file' || m.type==='audio'){ const lower=(m.fileUrl||'').toLowerCase(); if(m.fileUrl && /\.(png|jpe?g|gif|webp)$/i.test(lower)){ const img=document.createElement('img'); img.src=m.fileUrl; img.className='message-media image'; img.style.maxWidth='220px'; img.style.borderRadius='8px'; img.alt='image'; bubble.appendChild(img);} else if(m.fileUrl && /\.(mp4|webm|ogg)$/i.test(lower)){ const v=document.createElement('video'); v.src=m.fileUrl; v.controls=true; v.style.maxWidth='260px'; v.style.borderRadius='8px'; v.className='message-media video'; bubble.appendChild(v);} else if(m.fileUrl && (m.type==='audio' || /\.(mp3|wav|m4a|aac)$/i.test(lower))){ const a=document.createElement('audio'); a.src=m.fileUrl; a.controls=true; bubble.appendChild(a);} else if(m.text){ const p=document.createElement('div'); p.textContent=m.text; bubble.appendChild(p);} }
      else { const p=document.createElement('div'); p.textContent = m.text || ''; bubble.appendChild(p); }
    }
    if(meta){ meta.textContent = (formatTime(m.timestamp) + ((currentUser && m.senderId===currentUser.uid) ? (m.seenAt ? ' ✓✓' : ' ✓') : '')); }
  }catch(_){ }
}
    let selectedMediaFiles = [];
    let allMessages = [];
    let replyContext = null;
    let knownMessageIds = new Set();
    let chatMuted = false;
let readReceiptsEnabled = true;
let disappearingMs = 0;
let disappearingWatcher = null;
let __partnerTyping = false;
let __presenceTimer = null;

function getLastActiveMsFromProfile(p){
  try{
    if(!p) return 0;
    const v = p.lastActive;
    if(!v) return 0;
    if(typeof v?.toMillis === 'function') return v.toMillis();
    if(typeof v?.toDate === 'function') return v.toDate().getTime();
    const n = Number(v);
    return isNaN(n)? 0 : n;
  }catch(_){ return 0; }
}

function computePresenceState(p){
  const online = !!(p && p.online);
  const lastMs = getLastActiveMsFromProfile(p) || 0;
  const now = Date.now();
  const delta = now - lastMs;
  if(online && delta <= 15*1000) return { state:'online', lastMs };
  if(!lastMs) return { state:'offline', lastMs:0 };
  if(delta <= 5*60*1000) return { state:'away', lastMs };
  return { state:'offline', lastMs };
}

function renderPartnerPresence(){
  try{
    const wrap = partnerStatusEl;
    if(!wrap) return;
    if(__partnerTyping){
      wrap.innerHTML = '<span class="presence-row"><span class="presence-dot online"></span><span class="presence-text">Typing...</span></span>';
      return;
    }
    const { state, lastMs } = computePresenceState(partnerProfile||{});
    if(state === 'online'){
      wrap.innerHTML = '<span class="presence-row"><span class="presence-dot online"></span><span class="presence-text">Online</span></span>';
    } else if(state === 'away'){
      wrap.innerHTML = '<span class="presence-row"><span class="presence-dot away"></span><span class="presence-text">Just left</span></span>';
    } else {
      const txt = lastMs ? ('Last seen ' + new Date(lastMs).toLocaleString()) : 'Offline';
      wrap.innerHTML = '<span class="presence-row"><span class="presence-dot"></span><span class="presence-text">'+ txt +'</span></span>';
    }
  }catch(_){ }
}

function startPresenceAutoRefresh(){
  try{
    if(__presenceTimer) clearInterval(__presenceTimer);
    __presenceTimer = setInterval(()=> renderPartnerPresence(), 30000);
  }catch(_){ }
}

function applyPartnerData(data){
  try{
    partnerProfile = data || { username: 'Unknown', profilePicId: null };
    partnerNameEl.textContent = partnerProfile.username || 'User';
    displayProfilePicture(partnerAvatar, null, partnerProfile.profilePicId, (partnerProfile.username||'U').charAt(0), 'w_120,h_120,c_fill,g_face,r_max');
    renderPartnerPresence();
  }catch(_){ }
}

async function openChatWith(uid, hint){
  try{
    if(!currentUser) return;
    // Clean previous listeners
    if(unsubscribeMessages){ try{ unsubscribeMessages(); }catch(_){} unsubscribeMessages=null; }
    if(typingUnsub){ try{ typingUnsub(); }catch(_){} typingUnsub=null; }
    if(window.__partnerUnsub){ try{ window.__partnerUnsub(); }catch(_){} window.__partnerUnsub=null; }

    partnerId = uid;
    chatId = chatIdFor(currentUser.uid, partnerId);
    toggleViews(false);
    try{ history.replaceState(null,'', `/chat.html?partnerId=${partnerId}`); }catch(_){ }

    // Instant header from hint
    if(hint){
      try{
        partnerNameEl.textContent = hint.username || 'User';
        if(hint.avatarUrl){ partnerAvatar.src = hint.avatarUrl; }
        else if(hint.profilePicId){ displayProfilePicture(partnerAvatar, null, hint.profilePicId, (hint.username||'U').charAt(0), 'w_120,h_120,c_fill,g_face,r_max'); }
        else { partnerAvatar.src = `https://placehold.co/80x80/CCCCCC/000000?text=${encodeURIComponent((hint.username||'U').charAt(0))}`; }
        renderPartnerPresence();
      }catch(_){ }
    }

    // Live partner profile
    const partnerRef = doc(db,'artifacts',appId,'public','data','users', partnerId);
    try{ const ps = await getDoc(partnerRef); if(ps.exists()) applyPartnerData(ps.data()); }catch(_){ }
    try{ window.__partnerUnsub = onSnapshot(partnerRef, (snap)=>{ try{ if(snap.exists()) applyPartnerData(snap.data()); }catch(_){ } }); }catch(_){ }

    await ensureChatDoc(chatId, partnerId);
    startListening();
    loadMute();
    await loadChatSettings();
    startPresenceAutoRefresh();
    startUserHeartbeat(currentUser);
  }catch(_){ }
}

function startUserHeartbeat(user){
  try{
    if(!user) return;
    const userDocRef = doc(db,'artifacts',appId,'public','data','users', user.uid);
    const computeOnline = () => navigator.onLine && document.visibilityState === 'visible';
    const post = async ()=>{ try{ await setDoc(userDocRef, { online: computeOnline(), lastActive: serverTimestamp() }, { merge:true }); }catch(_){ } };
    post();
    if(window.__chatHeartbeat) clearInterval(window.__chatHeartbeat);
    window.__chatHeartbeat = setInterval(post, 15000);
    const debounced = ()=> post();
    window.addEventListener('online', debounced);
    window.addEventListener('offline', debounced);
    document.addEventListener('visibilitychange', debounced);
  }catch(_){ }
}

    // Friends cache
    let myFriends = [];
    let typingUnsub = null;
    let typingTimer = null;

// Friends presence (green only when truly online)
const friendPresenceUnsubs = new Map();

function tsToMillis(v){ try{ if(!v) return 0; if(typeof v.toMillis==='function') return v.toMillis(); if(typeof v.toDate==='function') return v.toDate().getTime(); const n=Number(v); return isNaN(n)?0:n; }catch(_){ return 0; } }
function isUserOnlineNow(data){ try{ const online = !!data?.online; if(!online) return false; const lastMs = tsToMillis(data?.lastActive); if(!lastMs) return false; const fresh = (Date.now() - lastMs) <= 15*1000; return fresh; }catch(_){ return false; } }
function updateFriendPresenceDot(friendId, data){ try{ const item = document.querySelector(`.friend-item[data-uid="${friendId}"]`); if(!item) return; const dot = item.querySelector('.presence-dot'); if(!dot) return; const online = isUserOnlineNow(data); if(online){ dot.classList.add('online'); dot.title='Online'; } else { dot.classList.remove('online'); dot.title='Offline'; } }catch(_){ } }
function subscribeFriendPresence(friendId){ try{ if(friendPresenceUnsubs.has(friendId)) return; const ref = doc(db,'artifacts',appId,'public','data','users', friendId); const unsub = onSnapshot(ref, (snap)=>{ updateFriendPresenceDot(friendId, snap.exists()? snap.data(): null); }, ()=>{}); friendPresenceUnsubs.set(friendId, unsub); }catch(_){ } }
window.addEventListener('beforeunload', ()=>{ try{ friendPresenceUnsubs.forEach(u=>u&&u()); friendPresenceUnsubs.clear(); }catch(_){ } });

    function chatIdFor(u1,u2){ return [u1,u2].sort().join('_'); }

    function toggleViews(showFriends){
      if(showFriends){
        friendsView.classList.remove('is-hidden');
        chatHeaderEl.style.display='none';
        chatMessages.style.display='none';
        chatInputAreaEl.style.display='none';
      }else{
        friendsView.classList.add('is-hidden');
        chatHeaderEl.style.display='flex';
        chatMessages.style.display='flex';
        chatInputAreaEl.style.display='flex';
      }
    }

    function renderFriendItem(f){
      const el = document.createElement('div');
      el.className = 'friend-item';
      el.dataset.uid = f.uid;
      const img = document.createElement('img');
      img.className = 'friend-avatar';
      const name = document.createElement('div');
      const sub = document.createElement('div');
      name.className = 'friend-name';
      sub.className = 'friend-sub';
      const dot = document.createElement('span'); dot.className = 'presence-dot'; dot.title='Offline';
      const nameText = document.createElement('span'); nameText.textContent = f.username || 'User';
      name.appendChild(dot); name.appendChild(nameText);
      sub.textContent = f.bio ? String(f.bio).slice(0,60) : '';
      const avatarUrl = f.profilePicId ? getCloudinaryImageUrl(f.profilePicId,'w_120,h_120,c_fill,g_face,r_max') : `https://placehold.co/80x80/CCCCCC/000000?text=${encodeURIComponent((f.username||'U').charAt(0))}`;
      img.src = avatarUrl;
      el.appendChild(img);
      const tc = document.createElement('div'); tc.style.display='flex'; tc.style.flexDirection='column'; tc.appendChild(name); tc.appendChild(sub);
      el.appendChild(tc);
      el.addEventListener('click', (ev)=>{
        ev.preventDefault();
        try{
          if(friendsView){ friendsView.classList.add('is-hidden'); friendsView.style.display='none'; }
        }catch(_){ }
        const hint = { uid: f.uid, username: f.username||'User', profilePicId: f.profilePicId||null, avatarUrl };
        openChatWith(f.uid, hint);
      });
      // Subscribe to presence updates (green only when truly online)
      subscribeFriendPresence(f.uid);
      return el;
    }

    function renderFriends(){
      const q = (friendSearchInput.value||'').toLowerCase().trim();
      friendsListEl.innerHTML = '';
      const list = myFriends.filter(f=> !q || (f.username||'').toLowerCase().includes(q));
      friendsEmpty.style.display = list.length? 'none':'block';
      friendsLoading.style.display = 'none';
      list.forEach(f=> friendsListEl.appendChild(renderFriendItem(f)));
    }

    async function fetchFriendsFor(uid){
      try{
        // Prefer filtered queries on public/data/friends
        const friendsCol = collection(db,'artifacts',appId,'public','data','friends');
        const [q1,q2] = [query(friendsCol, where('user1Id','==', uid)), query(friendsCol, where('user2Id','==', uid))];
        const [s1,s2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        const ids = new Set();
        s1.forEach(d=>{ const v=d.data(); if(v?.user2Id) ids.add(v.user2Id); });
        s2.forEach(d=>{ const v=d.data(); if(v?.user1Id) ids.add(v.user1Id); });
        // Fallback to per-user subcollection if none
        if(ids.size===0){
          const perUser = collection(db,'artifacts',appId,'users', uid, 'friends');
          const fs = await getDocs(perUser);
          fs.forEach(d=> ids.add(d.id));
        }
        // Fetch profiles
        const usersCol = collection(db,'artifacts',appId,'public','data','users');
        const profiles = await Promise.all(Array.from(ids).map(async id=>{
          try{ const s = await getDoc(doc(usersCol, id)); if(!s.exists()) return null; const data=s.data(); return { uid: id, username: data.username||id.slice(0,6), profilePicId: data.profilePicId||null, bio: data.bio||'' }; }catch(_){ return null; }
        }));
        myFriends = profiles.filter(Boolean).sort((a,b)=> (a.username||'').localeCompare(b.username||''));
        renderFriends();
      }catch(e){
        console.error('friends load',e); friendsLoading.textContent='Failed to load friends.'; friendsEmpty.style.display='block';
      }
    }

    function showMessage(text,type='info',duration=3000){ const mb=document.getElementById('messageBox'); if(!mb) return; mb.textContent=text; mb.style.display='block'; mb.className=type; setTimeout(()=>{ mb.style.display='none'; },duration); }

    function formatTime(ts){ try{ const d = ts && ts.toDate ? ts.toDate() : (ts? new Date(ts): new Date()); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }catch(e){ return ''; } }

    function clearMessages(){ chatMessages.innerHTML=''; }

    async function renderMessage(m){
      if(!m || !m.senderId) return;
      const isSent = currentUser && m.senderId === currentUser.uid;
      const item = document.createElement('div');
      item.className = 'message-item ' + (isSent? 'sent':'received');
      item.dataset.id = m.id;

      const avatarWrap = document.createElement('div');
      avatarWrap.className = 'avatar';
      const avatarImg = document.createElement('img');
      avatarImg.className = 'avatar';
      avatarImg.alt = 'avatar';
      avatarImg.loading = 'lazy';
      avatarImg.decoding = 'async';
      avatarImg.style.width='30px'; avatarImg.style.height='30px'; avatarImg.style.borderRadius='50%';
      if(isSent){ if(currentUser?.photoURL){ avatarImg.src = currentUser.photoURL; } else { avatarImg.src = `https://placehold.co/40x40/CCCCCC/000000?text=${encodeURIComponent((currentUser?.displayName||'U').charAt(0))}`; } }
      else { if(partnerProfile?.profilePicId){ avatarImg.src = getCloudinaryImageUrl(partnerProfile.profilePicId,'w_60,h_60,c_fill,g_face,r_max'); } else { avatarImg.src = `https://placehold.co/40x40/CCCCCC/000000?text=${encodeURIComponent((partnerProfile?.username||'U').charAt(0))}`; } }

      const contentWrap = document.createElement('div'); contentWrap.className='message-content';
      const bubble = document.createElement('div'); bubble.className='message-bubble';
      if(m.repliedToText){ const q=document.createElement('div'); q.className='reply-quote'; q.textContent = m.repliedToText; bubble.appendChild(q); }

      if(m.type === 'file' || m.type === 'audio'){
        // media
        const lower = (m.fileUrl||'').toLowerCase();
        if(m.fileUrl && /\.(png|jpe?g|gif|webp)$/i.test(lower)){
          const img = document.createElement('img'); img.src = m.fileUrl; img.className='message-media image'; img.style.maxWidth='220px'; img.style.borderRadius='8px'; img.alt='image'; bubble.appendChild(img);
        } else if(m.fileUrl && /\.(mp4|webm|ogg)$/i.test(lower)){
          const v = document.createElement('video'); v.src = m.fileUrl; v.controls = true; v.style.maxWidth='260px'; v.style.borderRadius='8px'; v.className='message-media video'; bubble.appendChild(v);
        } else if(m.fileUrl && (m.type==='audio' || /\.(mp3|wav|m4a|aac)$/i.test(lower))){
          const a = document.createElement('audio'); a.src = m.fileUrl; a.controls = true; bubble.appendChild(a);
        } else if(m.text){ const p=document.createElement('div'); p.textContent = m.text; bubble.appendChild(p); }
      } else {
        const p = document.createElement('div'); p.textContent = m.text || ''; bubble.appendChild(p);
      }

      const meta = document.createElement('div'); meta.className='message-meta'; meta.textContent = (formatTime(m.timestamp) + (isSent ? (m.seenAt ? ' ✓✓' : ' ✓') : ''));
      contentWrap.appendChild(bubble); contentWrap.appendChild(meta);

      const reactionBar = document.createElement('div'); reactionBar.className='reaction-bar';
      ['❤️','😂','��','😮','😢'].forEach(em=>{ const chip=document.createElement('button'); chip.className='reaction-chip'; chip.textContent=em; chip.addEventListener('click', ()=> toggleReaction(m.id, em)); reactionBar.appendChild(chip); });
      contentWrap.appendChild(reactionBar);

      const tools = document.createElement('div'); tools.className='message-tools';
      const actionsBtn = document.createElement('button'); actionsBtn.className='message-actions-btn'; actionsBtn.innerHTML = '<i class="fas fa-ellipsis-h"></i>';
      const menu = document.createElement('div'); menu.className='message-actions-menu';
      function addMenu(label, fn){ const b=document.createElement('button'); b.textContent=label; b.addEventListener('click', ()=>{ fn(); menu.classList.remove('open'); }); menu.appendChild(b); }
      addMenu('Reply', ()=> startReply(m));
      addMenu(m.pinned? 'Unpin':'Pin', ()=> togglePin(m));
      addMenu('Copy', ()=> copyMessage(m));
      if(isSent && m.type==='text' && !m.deleted){ addMenu('Edit', ()=> editMessage(m)); }
      if(isSent){ addMenu('Delete', ()=> deleteMessage(m)); }
      actionsBtn.addEventListener('click', ()=> menu.classList.toggle('open'));
      tools.appendChild(actionsBtn);
      contentWrap.appendChild(menu);
      contentWrap.appendChild(tools);

      // Load reactions count lazily
      try{ await loadReactions(m.id, reactionBar); }catch(_){ }

      item.appendChild(avatarImg);
      item.appendChild(contentWrap);

      chatMessages.appendChild(item);
    }

    async function ensureChatDoc(chatId, partnerId){ try{ const chatDocRef = doc(db,'artifacts',appId,'public','data','chats',chatId); const snap = await getDoc(chatDocRef); if(!snap.exists()){ await setDoc(chatDocRef, { participants:[currentUser.uid, partnerId], createdAt: serverTimestamp(), lastMessageAt: serverTimestamp() }, { merge:true }); } return true; }catch(e){ console.error('ensureChatDoc failed',e); return false; } }

    async function startListening(){
      if(!currentUser || !partnerId) return;
      chatId = chatIdFor(currentUser.uid, partnerId);
      const messagesRef = collection(db,'artifacts',appId,'public','data','chats',chatId,'messages');
      const q = query(messagesRef, orderBy('timestamp','asc'), limitToLast(100));

      // Typing listener for partner
      try{
        if(typingUnsub) typingUnsub();
        const partnerTypingRef = doc(db,'artifacts',appId,'public','data','chats',chatId,'typing', partnerId);
        typingUnsub = onSnapshot(partnerTypingRef, (snap)=>{
          const d = snap.data();
          if(d && d.typing && (Date.now() - (d.ts||0) < 5000)){
            __partnerTyping = true; renderPartnerPresence();
          }else{
            __partnerTyping = false; renderPartnerPresence();
          }
        }, ()=>{});
      }catch(_){ }

      // Instant render from cache
      try{
        const cached = loadMessagesCache(chatId);
        if(Array.isArray(cached) && cached.length){
          messagesLoading.style.display='none';
          allMessages = cached;
          knownMessageIds = new Set(cached.map(m=> m.id));
          clearMessages();
          cached.forEach(m=> renderMessage(m));
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }catch(_){ }

      if(unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = onSnapshot(q, async (snap)=>{
        const nearBottom = isNearBottom();
        const changes = snap.docChanges();
        let mutated = false;
        for(const ch of changes){
          const d = { id: ch.doc.id, ...ch.doc.data() };
          if(ch.type === 'added'){
            if(!knownMessageIds.has(d.id)){
              knownMessageIds.add(d.id);
              allMessages.push(d);
              appendOrUpdateMessage(d);
              mutated = true;
              try{
                if(d.receiverId === currentUser.uid && !d.seenAt){
                  if(readReceiptsEnabled){
                    const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', d.id);
                    await updateDoc(mref, { seenAt: serverTimestamp() });
                  }
                }
                if(d.senderId !== (currentUser&&currentUser.uid)) maybeNotify(d);
              }catch(_){ }
            }
          } else if(ch.type === 'modified'){
            const idx = allMessages.findIndex(x=> x.id===d.id);
            if(idx>-1){ allMessages[idx] = d; }
            appendOrUpdateMessage(d);
            mutated = true;
          } else if(ch.type === 'removed'){
            const idx = allMessages.findIndex(x=> x.id===d.id);
            if(idx>-1){ allMessages.splice(idx,1); }
            const el = document.querySelector(`.message-item[data-id="${d.id}"]`);
            if(el && el.parentNode) el.parentNode.removeChild(el);
            mutated = true;
          }
        }
        if(snap.docs.length===0){ messagesLoading.textContent='No messages yet. Say hello!'; messagesLoading.style.display='block'; }
        else { messagesLoading.style.display='none'; }
        if(mutated){ renderPinnedBar(); saveMessagesCache(chatId, allMessages); if(nearBottom) chatMessages.scrollTop = chatMessages.scrollHeight; }
      }, (err)=>{ console.error('messages listener',err); showMessage('Failed to load messages','error',4000); });
    }

    attachButton.addEventListener('click', ()=> mediaInput.click());
    cameraButton.addEventListener('click', ()=> cameraInput.click());
    mediaInput.addEventListener('change',(e)=>{
      const files = Array.from(e.target.files||[]); if(!files.length) return; selectedMediaFiles = selectedMediaFiles.concat(files);
      mediaFileName.textContent = selectedMediaFiles.length === 1 ? selectedMediaFiles[0].name : (selectedMediaFiles.length + ' files selected');
      mediaPreview.src = URL.createObjectURL(selectedMediaFiles[0]);
      mediaPreviewContainer.style.display='flex';
    });
    cameraInput.addEventListener('change',(e)=>{
      const files = Array.from(e.target.files||[]); if(!files.length) return; selectedMediaFiles = selectedMediaFiles.concat(files);
      mediaFileName.textContent = selectedMediaFiles.length === 1 ? selectedMediaFiles[0].name : (selectedMediaFiles.length + ' files selected');
      mediaPreview.src = URL.createObjectURL(selectedMediaFiles[0]);
      mediaPreviewContainer.style.display='flex';
    });
    removeMediaButton.addEventListener('click', ()=>{ selectedMediaFiles = []; mediaInput.value=''; cameraInput.value=''; mediaPreview.src=''; mediaPreviewContainer.style.display='none'; mediaFileName.textContent=''; document.getElementById('uploadProgress').style.display='none'; document.getElementById('uploadProgressBar').style.width='0%'; });

    // Drag & drop
    ['dragenter','dragover'].forEach(evt=> document.addEventListener(evt, e=>{ e.preventDefault(); chatInputAreaEl.classList.add('drag-over'); }));
    ;['dragleave','drop'].forEach(evt=> document.addEventListener(evt, e=>{ e.preventDefault(); chatInputAreaEl.classList.remove('drag-over'); }));
    document.addEventListener('drop', (e)=>{ const files = Array.from(e.dataTransfer?.files||[]); if(!files.length) return; selectedMediaFiles = selectedMediaFiles.concat(files); mediaFileName.textContent = selectedMediaFiles.length === 1 ? selectedMediaFiles[0].name : (selectedMediaFiles.length + ' files selected'); mediaPreview.src = URL.createObjectURL(selectedMediaFiles[0]); mediaPreviewContainer.style.display='flex'; });

    // Typing state
    function handleTypingEvent(){ try{ setTyping(true); clearTimeout(typingTimer); typingTimer = setTimeout(()=> setTyping(false), 1500); }catch(_){}}
    async function setTyping(active){ try{ if(!currentUser || !chatId) return; const myTypingRef = doc(db,'artifacts',appId,'public','data','chats',chatId,'typing', currentUser.uid); await setDoc(myTypingRef, { typing: !!active, ts: Date.now() }, { merge: true }); }catch(_){}}
    messageInput.addEventListener('input', handleTypingEvent);
    window.addEventListener('beforeunload', ()=>{ try{ setTyping(false); }catch(_){ } });


    function goBackToFriends(){
      try{
        if(unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages=null; }
        if(typingUnsub) { typingUnsub(); typingUnsub=null; }
        if(window.__partnerUnsub){ try{ window.__partnerUnsub(); }catch(_){ } window.__partnerUnsub=null; }
        knownMessageIds = new Set(); allMessages = []; clearMessages();
        const bar = document.getElementById('pinnedBar'); if(bar){ bar.style.display='none'; const list=document.getElementById('pinnedList'); if(list) list.innerHTML=''; }
        partnerId = null; partnerProfile = null; chatId = null;
        // Restore friends list instantly
        try{ Array.from(document.querySelectorAll('.friend-item')).forEach(it=> it.style.display=''); }catch(_){ }
        try{ if(friendSearchInput) friendSearchInput.value=''; }catch(_){ }
        if(friendsView){ friendsView.classList.remove('is-hidden'); friendsView.style.display=''; }
        if(myFriends && myFriends.length){ try{ renderFriends(); }catch(_){ } }
        else if(currentUser){ fetchFriendsFor(currentUser.uid).catch(()=>{}); }
        toggleViews(true);
        try{ history.replaceState(null,'','/chat.html'); }catch(_){ }
      }catch(_){ toggleViews(true); }
    }
    backBtn.addEventListener('click', (e)=>{ e.preventDefault(); goBackToFriends(); });
    viewProfileBtn.addEventListener('click', ()=>{ if(partnerId) window.location.href = `/profile.html?userId=${partnerId}`; });

    // Search, mute, menu
    const chatSearchWrap = document.getElementById('chatSearchWrap');
    const chatSearchInput = document.getElementById('chatSearchInput');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const muteToggleBtn = document.getElementById('muteToggleBtn');
    const headerMenuBtn = document.getElementById('headerMenuBtn');
    const replyBanner = document.getElementById('replyBanner');
    const replyText = document.getElementById('replyText');
    const replyCancelBtn = document.getElementById('replyCancelBtn');
    const notifSound = document.getElementById('notifSound');

    searchToggleBtn.addEventListener('click', ()=>{ chatSearchWrap.style.display = chatSearchWrap.style.display==='block' ? 'none' : 'block'; if(chatSearchWrap.style.display==='block'){ chatSearchInput.focus(); } });
    chatSearchInput.addEventListener('input', ()=> renderAllMessages(chatSearchInput.value.trim()));

    function updateMuteUI(){ muteToggleBtn.innerHTML = chatMuted ? '<i class="fas fa-bell"></i>' : '<i class="fas fa-bell-slash"></i>'; }
    function loadMute(){ try{ chatMuted = !!localStorage.getItem('mute_'+chatId); updateMuteUI(); }catch(_){ chatMuted=false; } }
    muteToggleBtn.addEventListener('click', ()=>{ chatMuted = !chatMuted; try{ if(chatMuted) localStorage.setItem('mute_'+chatId,'1'); else localStorage.removeItem('mute_'+chatId); }catch(_){ } updateMuteUI(); showMessage(chatMuted? 'Muted':'Unmuted'); });

    headerMenuBtn.addEventListener('click', async ()=>{
      const choice = prompt('Type: block or report'); if(!choice) return; const v = choice.toLowerCase(); if(v==='block'){ await blockUser(); } else if(v==='report'){ await reportUser(); }
    });

    replyCancelBtn.addEventListener('click', ()=> clearReply());

    async function uploadToCloudinary(file){ try{ const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', cloudinaryConfig.uploadPreset); const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`, { method:'POST', body:fd }); const data = await res.json(); if(data && (data.secure_url || data.url)) return { url: data.secure_url || data.url, raw: data }; return null; }catch(e){ console.error('upload failed',e); return null; } }

    function uploadToCloudinaryXHR(file, onProgress){ return new Promise((resolve)=>{ const url = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`; const xhr = new XMLHttpRequest(); const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', cloudinaryConfig.uploadPreset); xhr.open('POST', url); xhr.upload.onprogress = (e)=>{ if(e.lengthComputable && onProgress){ onProgress(Math.round((e.loaded/e.total)*100)); } }; xhr.onreadystatechange = ()=>{ if(xhr.readyState===4){ try{ const data = JSON.parse(xhr.responseText||'{}'); resolve(data && (data.secure_url||data.url)? { url: data.secure_url||data.url, raw: data } : null); }catch(_){ resolve(null); } } }; xhr.send(fd); }); }

    sendButton.addEventListener('click', async ()=>{
      if(!currentUser) { showMessage('Please sign in to send messages','warning'); return; }
      if(chatMuted && !confirm('Chat is muted. Send anyway?')) return;
      const text = (messageInput.value||'').trim(); if(!text && selectedMediaFiles.length===0) return; sendButton.disabled = true;
      try{
        await ensureChatDoc(chatIdFor(currentUser.uid, partnerId), partnerId);
        const messagesRef = collection(db,'artifacts',appId,'public','data','chats',chatIdFor(currentUser.uid, partnerId),'messages');
        if(selectedMediaFiles.length){
          document.getElementById('uploadProgress').style.display='block';
          for(const file of selectedMediaFiles){
            const up = await uploadToCloudinaryXHR(file, (p)=>{ document.getElementById('uploadProgressBar').style.width = p + '%'; });
            if(!up){ showMessage('Failed to upload media','error'); continue; }
            const lower=(file.type||'').toLowerCase();
            const type = lower.startsWith('image/')? 'file' : (lower.startsWith('video/')? 'file' : 'audio');
            await addDoc(messagesRef, { text: '', senderId: currentUser.uid, receiverId: partnerId, timestamp: serverTimestamp(), status: 'sent', chatId: chatIdFor(currentUser.uid, partnerId), type, fileUrl: up.url, fileName: file.name, repliedToId: replyContext?.id||null, repliedToText: replyContext?.text||null });
          }
          document.getElementById('uploadProgress').style.display='none';
          document.getElementById('uploadProgressBar').style.width='0%';
          selectedMediaFiles = []; mediaPreviewContainer.style.display='none'; mediaInput.value=''; cameraInput.value=''; mediaPreview.src=''; mediaFileName.textContent='';
        }
        if(text){ await addDoc(messagesRef, { text, senderId: currentUser.uid, receiverId: partnerId, timestamp: serverTimestamp(), status: 'sent', chatId: chatIdFor(currentUser.uid, partnerId), type: 'text', repliedToId: replyContext?.id||null, repliedToText: replyContext?.text||null }); }
        clearReply();
        messageInput.value='';
      }catch(e){ console.error('send failed',e); showMessage('Failed to send message','error'); }
      sendButton.disabled=false;
    });

    async function loadReactions(messageId, barEl){ try{ const rcol = collection(db,'artifacts',appId,'public','data','chats',chatId,'messages', messageId, 'reactions'); const qs = await getDocs(rcol); const counts = {}; let myEmoji=null; qs.forEach(d=>{ const e=d.data()?.emoji; if(d.id === (currentUser&&currentUser.uid)) myEmoji=e||null; if(e){ counts[e]=(counts[e]||0)+1; } }); Array.from(barEl.children).forEach(ch=>{ const em = ch.textContent.replace(/\s\d+$/,''); const c = counts[em]||0; ch.textContent = c? (em+' '+c) : em; if(myEmoji===em) ch.classList.add('active'); else ch.classList.remove('active'); }); }catch(_){ }}
    async function toggleReaction(messageId, emoji){ try{ const rdoc = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', messageId, 'reactions', currentUser.uid); const snap = await getDoc(rdoc); const cur = snap.exists() ? snap.data()?.emoji : null; const val = cur===emoji ? null : emoji; await setDoc(rdoc, { emoji: val, ts: Date.now() }, { merge:true }); }catch(_){ }}

    function renderPinnedBar(){ const pinned = allMessages.filter(m=> m.pinned); const bar = document.getElementById('pinnedBar'); const list = document.getElementById('pinnedList'); if(pinned.length===0){ bar.style.display='none'; list.innerHTML=''; return; } bar.style.display='block'; list.innerHTML=''; pinned.forEach(m=>{ const chip=document.createElement('button'); chip.className='pinned-chip'; chip.textContent = (m.text? m.text.slice(0,24): (m.fileName||'Attachment')); chip.addEventListener('click', ()=>{ const el = Array.from(document.querySelectorAll('.message-item')).find(x=> x.dataset && x.dataset.id===m.id); if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); } }); list.appendChild(chip); }); }

    function renderAllMessages(filterText=''){ clearMessages(); const ft = (filterText||'').toLowerCase(); const docs = ft? allMessages.filter(m=> ((m.text||'').toLowerCase().includes(ft) || (m.fileName||'').toLowerCase().includes(ft))) : allMessages; docs.forEach(d=> renderMessage(d)); }

    function startReply(m){ replyContext = { id: m.id, text: m.text||m.fileName||'Attachment' }; replyText.textContent = 'Replying to: '+ replyContext.text.slice(0,80); replyBanner.style.display='flex'; }
    function clearReply(){ replyContext=null; replyText.textContent=''; replyBanner.style.display='none'; }

    function copyMessage(m){ const text = m.text || m.fileUrl || ''; if(!text) return; navigator.clipboard?.writeText(text); showMessage('Copied'); }
    async function editMessage(m){ const t = prompt('Edit message', m.text||''); if(t===null) return; try{ const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', m.id); await updateDoc(mref, { text: t, editedAt: serverTimestamp() }); }catch(_){ showMessage('Failed to edit','error'); } }
    async function deleteMessage(m){ if(!confirm('Delete this message?')) return; try{ const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', m.id); await updateDoc(mref, { deleted: true, text: 'Message deleted' }); }catch(_){ showMessage('Failed to delete','error'); } }
    async function togglePin(m){ try{ const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', m.id); await updateDoc(mref, { pinned: !m.pinned }); }catch(_){ showMessage('Failed to pin','error'); } }

    function maybeNotify(d){ try{ if(chatMuted) return; if(document.visibilityState==='visible') return; if(notifSound) notifSound.play().catch(()=>{}); if('Notification' in window){ if(Notification.permission==='granted'){ new Notification(partnerProfile?.username||'New message', { body: d.text||d.fileName||'Attachment' }); } else if(Notification.permission!=='denied'){ Notification.requestPermission(); } } }catch(_){ }}

    async function blockUser(){ try{ await setDoc(doc(db,'artifacts',appId,'users', currentUser.uid, 'blocks', partnerId), { blockedAt: serverTimestamp() }, { merge:true }); showMessage('User blocked'); }catch(_){ showMessage('Failed to block','error'); } }
    async function reportUser(){ try{ await addDoc(collection(db,'artifacts',appId,'public','data','reports'), { type:'chatAbuse', reporterId: currentUser.uid, reportedId: partnerId, at: serverTimestamp(), chatId }); showMessage('Reported'); }catch(_){ showMessage('Failed to report','error'); } }

    // Read receipts per-chat
    function updateReadReceiptsUI(){ try{ if(!readReceiptsToggleBtn) return; readReceiptsToggleBtn.title = readReceiptsEnabled ? 'Read receipts: ON' : 'Read receipts: OFF'; readReceiptsToggleBtn.innerHTML = readReceiptsEnabled ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-eye-slash"></i>'; }catch(_){ } }
    function loadReadReceipts(){ try{ if(!chatId) return; const v = localStorage.getItem('readreceipt_'+chatId); readReceiptsEnabled = v !== '0'; updateReadReceiptsUI(); }catch(_){ readReceiptsEnabled = true; } }
    function setReadReceipts(enabled){ try{ readReceiptsEnabled = !!enabled; if(!chatId) return; if(readReceiptsEnabled) localStorage.removeItem('readreceipt_'+chatId); else localStorage.setItem('readreceipt_'+chatId,'0'); updateReadReceiptsUI(); showMessage('Read receipts ' + (readReceiptsEnabled? 'enabled':'disabled')); }catch(_){ } }
    if(readReceiptsToggleBtn){ readReceiptsToggleBtn.addEventListener('click', ()=> setReadReceipts(!readReceiptsEnabled)); }

    // Disappearing messages (per chat)
    async function setDisappearingDuration(ms){ try{ disappearingMs = Number(ms)||0; if(!chatId) return; const chatDocRef = doc(db,'artifacts',appId,'public','data','chats',chatId); await updateDoc(chatDocRef, { disappearingMs: disappearingMs }); startDisappearingWatcher(); showMessage(disappearingMs? ('Disappearing messages set to '+ (disappearingMs/1000)+'s') : 'Disappearing messages turned off'); }catch(e){ console.error('set disappearing',e); showMessage('Failed to set disappearing','error'); } }
    function startDisappearingWatcher(){ try{ if(disappearingWatcher) clearInterval(disappearingWatcher); if(!disappearingMs || disappearingMs<=0) return; disappearingWatcher = setInterval(async ()=>{ try{ const now = Date.now(); for(const m of allMessages.slice()){ if(!m || m.deleted) continue; const ts = tsToMillis(m.timestamp); if(!ts) continue; if(now - ts > disappearingMs){ try{ const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', m.id); await updateDoc(mref, { deleted: true, text: 'Message disappeared' }); }catch(_){ } } } }catch(_){ } }, 30000); }catch(_){ } }
    async function loadDisappearingSetting(){ try{ if(!chatId) return; const chatDocRef = doc(db,'artifacts',appId,'public','data','chats',chatId); try{ const snap = await getDoc(chatDocRef); if(snap.exists()){ disappearingMs = snap.data()?.disappearingMs || 0; } }catch(_){ } try{ onSnapshot(chatDocRef, (snap)=>{ if(snap.exists()){ disappearingMs = snap.data()?.disappearingMs || 0; startDisappearingWatcher(); } }); }catch(_){ } startDisappearingWatcher(); }catch(_){ } }

    // Simple call signaling (creates call record) - lightweight
    async function startCall(type){ try{ if(!currentUser || !partnerId) return; const callsRef = collection(db,'artifacts',appId,'public','data','chats',chatId,'calls'); const cdoc = await addDoc(callsRef, { type, callerId: currentUser.uid, calleeId: partnerId, status: 'initiated', createdAt: serverTimestamp() }); showMessage('Call initiated'); // show a basic UI
        const cid = cdoc.id; const w = window.open('', '_blank', 'width=400,height=700'); if(w){ w.document.title = type + ' call'; w.document.body.style.background = '#0b0b12'; w.document.body.style.color = '#fff'; w.document.body.innerHTML = '<div style="padding:20px;font-family:Inter,sans-serif"><h2>'+ (type==='video'?'Video':'Voice') +' call</h2><p>Call id: '+ cid +'</p><p>Use your app to accept/handle the call.</p></div>'; }
      }catch(e){ console.error('call failed',e); showMessage('Failed to start call','error'); } }
    if(callBtn) callBtn.addEventListener('click', ()=> startCall('voice'));
    if(videoCallBtn) videoCallBtn.addEventListener('click', ()=> startCall('video'));

    // vanish menu handlers
    if(vanishBtn && vanishMenu){ vanishBtn.addEventListener('click', ()=> vanishMenu.classList.toggle('open'));
      Array.from(vanishMenu.querySelectorAll('button')).forEach(b=> b.addEventListener('click', ()=>{ const v = Number(b.dataset.value||'0'); vanishMenu.classList.remove('open'); setDisappearingDuration(v); })); }

    // Load settings on chat open
    async function loadChatSettings(){ try{ loadReadReceipts(); await loadDisappearingSetting(); }catch(_){ } }

    // Ensure settings are loaded whenever chat opens
    // call loadChatSettings() from openChatWith after partner load

    // Init
    function getParam(name){ const sp=new URLSearchParams(window.location.search); return sp.get(name); }
    partnerId = getParam('partnerId');
    if(!partnerId){ toggleViews(true); }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(user){
        // header profile
        try{ const privateProfileRef = doc(db,'artifacts',appId,'users',user.uid,'profiles','user_profile'); const snap = await getDoc(privateProfileRef); let pdata = snap.exists()? snap.data() : { username: user.displayName || 'User', profilePicId: user.photoURL || null };
          displayProfilePicture(headerProfilePic, headerAvatarIcon, pdata.profilePicId, (pdata.username||'U').charAt(0), 'w_70,h_70,c_fill,g_face,r_max'); headerDisplayName.textContent = pdata.username || user.displayName || 'User'; profileLink.href = `/profile.html?userId=${user.uid}`;
        }catch(e){ console.warn('failed header profile',e); }

        if(!partnerId){ await fetchFriendsFor(user.uid); toggleViews(true); return; }

        // fast enter chat view and hydrate from hint
        try{
          toggleViews(false);
          const hintRaw = sessionStorage.getItem('chat:partnerHint:'+partnerId);
          if(hintRaw){
            const hint = JSON.parse(hintRaw);
            partnerNameEl.textContent = hint.username || 'User';
            if(hint.avatarUrl){ partnerAvatar.src = hint.avatarUrl; }
            else if(hint.profilePicId){ displayProfilePicture(partnerAvatar, null, hint.profilePicId, (hint.username||'U').charAt(0), 'w_120,h_120,c_fill,g_face,r_max'); }
            else { partnerAvatar.src = `https://placehold.co/80x80/CCCCCC/000000?text=${encodeURIComponent((hint.username||'U').charAt(0))}`; }
            renderPartnerPresence();
            sessionStorage.removeItem('chat:partnerHint:'+partnerId);
          } else {
            // minimal placeholder
            partnerNameEl.textContent = 'Loading...';
          }
        }catch(_){ }
        // load partner profile
        try{
          const partnerRef = doc(db,'artifacts',appId,'public','data','users',partnerId);
          try{
            const psnap = await getDoc(partnerRef);
            if(psnap.exists()) applyPartnerData(psnap.data()); else applyPartnerData(null);
          }catch(_){ applyPartnerData(null); }
          try{
            if(window.__partnerUnsub) window.__partnerUnsub();
            window.__partnerUnsub = onSnapshot(partnerRef, (snap)=>{ try{ if(snap.exists()) applyPartnerData(snap.data()); }catch(_){ } });
          }catch(_){}
        }catch(e){ console.error('load partner',e); }

        toggleViews(false);
        await ensureChatDoc(chatIdFor(currentUser.uid, partnerId), partnerId);
        startListening();
        loadMute();
        await loadChatSettings();
        startPresenceAutoRefresh(); startUserHeartbeat(currentUser);
      } else {
        // not signed in - redirect to login
        console.log('no user, redirect to login');
        setTimeout(()=> window.location.href = '/login.html', 800);
      }
    });
  </script>
</body>
</html>
